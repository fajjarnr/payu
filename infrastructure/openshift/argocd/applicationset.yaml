apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: payu-services
  namespace: openshift-gitops
  labels:
    app: payu
    type: applicationset
spec:
  generators:
    # Git Directory Generator - Auto-discover services
    - git:
        repoURL: https://github.com/payu-digital/payu-platform.git
        revision: main
        directories:
          - path: infrastructure/openshift/base/*
        values:
          environment: staging

    # Cluster Generator - Multi-environment support
    - clusters:
        selector:
          matchLabels:
            argocd.argoproj.io/secret-type: cluster
        values:
          environment: prod

  template:
    metadata:
      name: '{{path.basename}}-{{values.environment}}'
      labels:
        app: payu
        service: '{{path.basename}}'
        environment: '{{values.environment}}'
    spec:
      project: payu
      source:
        repoURL: https://github.com/payu-digital/payu-platform.git
        targetRevision: main
        path: infrastructure/openshift/base/{{path.basename}}
        helm:
          valueFiles:
            - ../../overlays/{{values.environment}}/values.yaml

      destination:
        namespace: 'payu-{{values.environment}}'
        server: '{{server}}'

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - PruneLast=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
        managedNamespaceMetadata:
          labels:
            app: payu
            environment: '{{values.environment}}'
          annotations:
            argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true

      # Sync Waves for dependency ordering
      ignoreDifferences:
        - group: apps.openshift.io
          kind: DeploymentConfig
          jqPathExpressions:
            - .spec.template.metadata.annotations

      # Health checks
      healthCheck:
        timeout: 300
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: payu-monitoring
  namespace: openshift-gitops
  labels:
    app: payu
    type: monitoring
spec:
  generators:
    - git:
        repoURL: https://github.com/payu-digital/payu-platform.git
        revision: main
        directories:
          - path: infrastructure/openshift/monitoring/*

  template:
    metadata:
      name: 'monitoring-{{path.basename}}'
      labels:
        app: payu
        component: monitoring
    spec:
      project: payu-monitoring
      source:
        repoURL: https://github.com/payu-digital/payu-platform.git
        targetRevision: main
        path: '{{path}}'
      destination:
        namespace: openshift-monitoring
        server: https://kubernetes.default.svc
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: payu-pr-previews
  namespace: openshift-gitops
  labels:
    app: payu
    type: pr-preview
spec:
  generators:
    # Pull Request Generator
    - pullRequest:
        github:
          owner: payu-digital
          repo: payu-platform
          tokenRef:
            secretName: github-token
            key: token
        requeueAfterSeconds: 180

  template:
    metadata:
      name: 'pr-{{number}}-{{head_short_sha}}'
      labels:
        app: payu
        type: pr-preview
        pr-number: '{{number}}'
        commit-sha: '{{head_short_sha}}'
      annotations:
        argocd.argoproj.io/preview-environment: "true"
        pr-url: '{{url}}'
        branch-name: '{{branch}}'
    spec:
      project: payu-preview
      source:
        repoURL: https://github.com/payu-digital/payu-platform.git
        targetRevision: '{{head_sha}}'
        path: infrastructure/openshift/base/account-service
        helm:
          parameters:
            - name: image.tag
              value: 'pr-{{number}}'
            - name: namespace
              value: 'payu-pr-{{number}}'

      destination:
        namespace: 'payu-pr-{{number}}'
        server: https://kubernetes.default.svc

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        managedNamespaceMetadata:
          labels:
            type: pr-preview
            pr-number: '{{number}}'
            auto-cleanup: "true"

      # Prune resources when PR is closed
      ignoreDifferences:
        - group: argoproj.io
          kind: Application
          jsonPointers:
            - /status
