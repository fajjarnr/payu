server:
  port: 8084
  shutdown: graceful

spring:
  application:
    name: wallet-service

  datasource:
    # Primary datasource for write operations
    primary:
      jdbc-url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/payu_wallets
      username: ${DB_USERNAME:postgres}
      password: ${DB_PASSWORD:postgres}
      driver-class-name: org.postgresql.Driver
      hikari:
        # Pool configuration
        maximum-pool-size: 20
        minimum-idle: 10
        connection-timeout: 30000
        idle-timeout: 600000
        max-lifetime: 1800000
        connection-test-query: SELECT 1
        validation-timeout: 5000
        auto-commit: false
        leak-detection-threshold: 60000
        pool-name: primary-pool

    # Read replica datasource for reporting/analytics queries
    read-replica:
      enabled: ${READ_REPLICA_ENABLED:false}
      jdbc-url: jdbc:postgresql://${READ_REPLICA_HOST:localhost}:${READ_REPLICA_PORT:5433}/payu_wallets_replica
      username: ${READ_REPLICA_USERNAME:postgres}
      password: ${READ_REPLICA_PASSWORD:postgres}
      driver-class-name: org.postgresql.Driver
      hikari:
        # Larger pool for reads (typically 2x primary)
        maximum-pool-size: 40
        minimum-idle: 20
        connection-timeout: 30000
        idle-timeout: 600000
        max-lifetime: 1800000
        connection-test-query: SELECT 1
        validation-timeout: 5000
        auto-commit: true
        leak-detection-threshold: 60000
        pool-name: read-replica-pool
        read-only: true

  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 20
          order_inserts: true
          order_updates: true
        # Query optimization
        generate_statistics: false
        use_sql_comments: true
        # Connection pool optimization
        connection:
          provider_disables_autocommit: true

  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true

  kafka:
    bootstrap-servers: ${KAFKA_BROKERS:localhost:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      retries: 3
      acks: all
      properties:
        retry.backoff.ms: 1000
        enable.idempotence: true
    consumer:
      group-id: wallet-service-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
        session.timeout.ms: 30000
        heartbeat.interval.ms: 10000

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${OIDC_ISSUER:http://localhost:8180/realms/payu}
          jwk-set-uri: ${OIDC_JWK_SET_URI:http://localhost:8180/realms/payu/protocol/openid-connect/certs}

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
      db:
        enabled: true
      redis:
        enabled: true
      kafka:
        enabled: true
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
  tracing:
    sampling:
      probability: 0.1
  otlp:
    tracing:
      endpoint: ${OTEL_ENDPOINT:http://localhost:4317}
    headers:
      Authorization:
  zipkin:
    tracing:
      endpoint: ${OTEL_ENDPOINT:http://localhost:4317}/v1/spans
  metrics:
    export:
      prometheus:
        enabled: true

resilience4j:
  circuitbreaker:
    instances:
      accountService:
        register-health-indicator: true
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2000ms
  retry:
    instances:
      accountService:
        max-attempts: 3
        wait-duration: 1s
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - java.net.ConnectException
          - java.util.concurrent.TimeoutException
        ignore-exceptions:
          - java.lang.IllegalArgumentException
  timelimiter:
    instances:
      accountService:
        timeout-duration: 5s

# PayU Configuration
payu:
  cache:
    enabled: true
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      pool-size: 20
      timeout: 5s
      command-timeout: 3s
    default-ttl: 5m
    cache-warming:
      enabled: true
      startup-delay: 10s
      async: true
      thread-pool-size: 4
    invalidation:
      enabled: true
      topic: cache-invalidation
      consumer-group: wallet-cache-invalidation-group
    local-cache:
      enabled: true
      max-size: 1000
      ttl: 1m
      record-stats: true
    caches:
      balances:
        ttl: 1m
        stale-while-revalidate: true
      pockets:
        ttl: 5m
        stale-while-revalidate: false
    metrics:
      enabled: true
      prefix: cache
      percentiles: true
      histogram: true

logging:
  level:
    root: INFO
    id.payu.wallet: DEBUG
    org.springframework.security: WARN

springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
  show-actuator: true
  packages-to-scan: id.payu.wallet
