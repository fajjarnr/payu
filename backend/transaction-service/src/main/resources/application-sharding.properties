# ===================================================================
# Transaction Service - Sharding/Partitioning Configuration
# ===================================================================
# This configuration file contains settings for database sharding using
# PostgreSQL declarative partitioning by hash on sender_account_id.
#
# To enable sharding:
# 1. Set sharding.enabled=true
# 2. Run Flyway migration V5__sharding_init.sql
# 3. (Optional) Migrate existing data: SELECT migrate_to_partitions();
# 4. Verify with: SELECT * FROM get_migration_status();
# ===================================================================

# Enable/disable sharding feature
# When false, queries use the legacy transactions table
# When true, queries use the partitioned transactions_partitioned table
sharding.enabled=false

# Number of partitions for hash partitioning
# Must be a power of 2: 4, 8, 16, or 32
# Choose based on expected data volume and query patterns
# - 4 partitions: For low to moderate volume (< 1M transactions)
# - 8 partitions: For moderate volume (1M-10M transactions) [RECOMMENDED]
# - 16 partitions: For high volume (10M-100M transactions)
# - 32 partitions: For very high volume (> 100M transactions)
sharding.partition-count=8

# Enable automatic data migration from legacy table to partitions
# When true, the application will automatically migrate existing data
sharding.auto-migrate=true

# Batch size for data migration
# Adjust based on memory constraints and performance requirements
sharding.migration-batch-size=1000

# Enable cross-partition queries for recipient lookups
# When true, queries by recipient_account_id will scan all partitions
# When false, only sender_account_id queries are supported (faster)
sharding.enable-cross-partition-queries=true

# Maximum parallelism for cross-partition queries
# Limits the number of partitions queried concurrently
# Should not exceed the number of CPU cores
sharding.max-query-parallelism=4

# Partition key field name
# Must match the field name in Transaction entity
sharding.partition-key=senderAccountId

# ===================================================================
# Partition Routing Strategy
# ===================================================================
# Hash Partitioning:
# - Partition number = hash(sender_account_id) % partition_count
# - Ensures even distribution of data across partitions
# - Enables efficient partition pruning for sender queries
# - Recipient queries require scanning all partitions
#
# Query Performance:
# - findBySenderAccountId: Single partition (fast)
# - findByReferenceNumber: Global index (fast)
# - findByRecipientAccountId: All partitions (slower)
# - findByAccountId: Combined sender + recipient lookup
# ===================================================================

# ===================================================================
# Migration Guidelines
# ===================================================================
# 1. Initial Setup:
#    - Set sharding.enabled=false
#    - Deploy application with V5 migration
#    - Verify partitioned tables are created
#
# 2. Data Migration:
#    - Execute: SELECT migrate_to_partitions();
#    - Monitor: SELECT * FROM get_migration_status();
#    - Verify counts match: SELECT COUNT(*) FROM transactions;
#                       SELECT COUNT(*) FROM transactions_partitioned;
#
# 3. Enable Sharding:
#    - Set sharding.enabled=true
#    - Deploy application
#    - Monitor query performance
#
# 4. Cleanup (optional):
#    - After verification, drop legacy table:
#      DROP TABLE transactions CASCADE;
#    - Or keep as backup for rollback
# ===================================================================

# ===================================================================
# Monitoring Queries
# ===================================================================
# Check partition sizes:
#   SELECT
#     schemaname,
#     tablename,
#     pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
#   FROM pg_tables
#   WHERE tablename LIKE 'transactions_partition%'
#   ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
#
# Check partition distribution:
#   SELECT
#     'transactions_partition_' || (hashtext(sender_account_id::text) % 8) AS partition,
#     COUNT(*) AS count
#   FROM transactions_partitioned
#   GROUP BY partition
#   ORDER BY partition;
#
# Check query performance:
#   EXPLAIN ANALYZE
#   SELECT * FROM transactions_partitioned
#   WHERE sender_account_id = 'your-uuid-here';
# ===================================================================
