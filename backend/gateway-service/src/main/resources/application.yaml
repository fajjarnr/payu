# PayU API Gateway Configuration
quarkus:
  application:
    name: gateway-service
    version: 1.0.0

  # HTTP Server
  http:
    port: 8080

  # OIDC Configuration (Red Hat SSO / Keycloak)
  oidc:
    enabled: ${OIDC_ENABLED:false}
    auth-server-url: ${OIDC_AUTH_SERVER_URL:http://localhost:8180/realms/payu}
    client-id: ${OIDC_CLIENT_ID:gateway-service}
    credentials:
      secret: ${OIDC_CLIENT_SECRET:secret}
    tls:
      verification: none
    token:
      issuer: ${OIDC_ISSUER:http://localhost:8180/realms/payu}

  # Redis Configuration (for rate limiting & caching)
  redis:
    hosts: ${REDIS_URL:redis://localhost:6379}
    password: ${REDIS_PASSWORD:}
    timeout: 5s

  # Health & Metrics
  smallrye-health:
    ui:
      enable: true

  micrometer:
    export:
      prometheus:
        path: /q/metrics
    binder:
      http-server:
        enabled: true
      jvm: true

  # OpenTelemetry
  otel:
    service:
      name: gateway-service
    exporter:
      otlp:
        endpoint: ${OTEL_ENDPOINT:http://localhost:4317}
    resource:
      attributes:
        - service.name=gateway-service
        - service.version=1.0.0

  # OpenAPI
  smallrye-openapi:
    info-title: PayU API Gateway
    info-version: 1.0.0
    info-description: API Gateway for PayU Digital Banking Platform
    info-contact-name: PayU Engineering Team
    info-contact-email: engineering@payu.id
    path: /q/openapi

  # Logging
  log:
    level: INFO
    category:
      "id.payu.gateway":
        level: DEBUG
      "io.quarkus.oidc":
        level: DEBUG
    console:
      format: "%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%X{correlationId}] [%c{3.}] (%t) %s%e%n"
      json: false

# Gateway Configuration
gateway:
  # Backend Services
  services:
    account-service:
      url: ${ACCOUNT_SERVICE_URL:http://localhost:8081}
      timeout: 30s
    auth-service:
      url: ${AUTH_SERVICE_URL:http://localhost:8082}
      timeout: 10s
    transaction-service:
      url: ${TRANSACTION_SERVICE_URL:http://localhost:8083}
      timeout: 30s
    wallet-service:
      url: ${WALLET_SERVICE_URL:http://localhost:8084}
      timeout: 15s
    billing-service:
      url: ${BILLING_SERVICE_URL:http://localhost:8085}
      timeout: 30s
    notification-service:
      url: ${NOTIFICATION_SERVICE_URL:http://localhost:8086}
      timeout: 10s
    kyc-service:
      url: ${KYC_SERVICE_URL:http://localhost:8087}
      timeout: 60s
    analytics-service:
      url: ${ANALYTICS_SERVICE_URL:http://localhost:8088}
      timeout: 30s
    partner-service:
      url: ${PARTNER_SERVICE_URL:http://localhost:8089}
      timeout: 30s
    promotion-service:
      url: ${PROMOTION_SERVICE_URL:http://localhost:8090}
      timeout: 30s
    lending-service:
      url: ${LENDING_SERVICE_URL:http://localhost:8091}
      timeout: 30s
    investment-service:
      url: ${INVESTMENT_SERVICE_URL:http://localhost:8092}
      timeout: 30s
    compliance-service:
      url: ${COMPLIANCE_SERVICE_URL:http://localhost:8093}
      timeout: 30s
    backoffice-service:
      url: ${BACKOFFICE_SERVICE_URL:http://localhost:8094}
      timeout: 30s
    support-service:
      url: ${SUPPORT_SERVICE_URL:http://localhost:8095}
      timeout: 30s

  # Simulators
  simulators:
    bi-fast:
      url: ${BIFAST_SIMULATOR_URL:http://localhost:9090}
      timeout: 30s
    dukcapil:
      url: ${DUKCAPIL_SIMULATOR_URL:http://localhost:9091}
      timeout: 30s
    qris:
      url: ${QRIS_SIMULATOR_URL:http://localhost:9092}
      timeout: 15s

  # CORS Configuration (strict mode)
  cors:
    enabled: true
    allowed-origins: https://payu.id,http://localhost:3000,http://localhost:8081
    allowed-methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
    allowed-headers: Content-Type,Authorization,X-Request-Id,X-Correlation-Id,X-Client-Id
    exposed-headers: X-Request-Id,X-Correlation-Id
    allow-credentials: true
    max-age: 3600

  # Rate Limiting
  rate-limit:
    enabled: true
    default:
      requests-per-minute: 60
      burst: 100
    endpoints:
      auth:
        requests-per-minute: 5
        burst: 10
      otp:
        requests-per-minute: 3
        burst: 5
      transfer:
        requests-per-minute: 10
        burst: 20
      balance:
        requests-per-minute: 30
        burst: 50
      accounts:
        requests-per-minute: 40
        burst: 60
      wallets:
        requests-per-minute: 30
        burst: 50
      cards:
        requests-per-minute: 30
        burst: 50
      transactions:
        requests-per-minute: 40
        burst: 60
      payments:
        requests-per-minute: 20
        burst: 30
      billers:
        requests-per-minute: 30
        burst: 50
      partners:
        requests-per-minute: 20
        burst: 30
      promotions:
        requests-per-minute: 40
        burst: 60
      lending:
        requests-per-minute: 20
        burst: 30
      investments:
        requests-per-minute: 20
        burst: 30
      compliance:
        requests-per-minute: 15
        burst: 25
      backoffice:
        requests-per-minute: 30
        burst: 50
      support:
        requests-per-minute: 30
        burst: 50
      notifications:
        requests-per-minute: 40
        burst: 60
      cashbacks:
        requests-per-minute: 30
        burst: 50
      loyalty-points:
        requests-per-minute: 30
        burst: 50
      rewards:
        requests-per-minute: 30
        burst: 50
      referrals:
        requests-per-minute: 20
        burst: 30

  # Circuit Breaker
  circuit-breaker:
    enabled: true
    failure-ratio: 0.5
    delay: 30s
    success-threshold: 3

  # Request/Response Logging
  logging:
    enabled: true
    log-body: false
    max-body-size: 1024

  # Tenant Configuration (Multitenancy)
  tenant:
    enabled: true
    default-tenant-id: "default"
    strict-mode: false
    header-name: "X-Tenant-Id"

  # API Versioning
  versioning:
    enabled: true
    default-version: "v1"
    supported-versions:
      - "v1"
      - "v2"
    header-name: "X-API-Version"
    deprecated-versions: []

  # Request Validation
  validation:
    enabled: true
    schema-validation: true
    max-request-size: 10485760  # 10MB
    strict-mode: false

  # Response Compression
  compression:
    enabled: true
    min-size: 1024  # Only compress responses larger than 1KB
    algorithms:
      - "gzip"
      - "br"  # Brotli (if available)
    level: 6  # Compression level (1-9)
    mime-types:
      - "application/json"
      - "application/xml"
      - "text/html"
      - "text/plain"
      - "text/css"
      - "text/javascript"
      - "application/javascript"

  # API Analytics
  analytics:
    enabled: true
    retention-days: 90
    batch-size: 100
    flush-interval: 60s  # Flush metrics every minute
    track:
      - "request-count"
      - "response-time"
      - "error-rate"
      - "status-codes"
      - "user-agents"
      - "endpoints"

  # Enhanced Rate Limiting with bucket4j
  rate-limit-v2:
    enabled: true
    algorithm: "token-bucket"  # token-bucket, leaky-bucket, fixed-window
    default:
      capacity: 100
      refill-tokens: 60
      refill-duration: "60s"
    per-user:
      enabled: true
      capacity: 1000
      refill-tokens: 100
      refill-duration: "60s"
    per-ip:
      enabled: true
      capacity: 200
      refill-tokens: 20
      refill-duration: "60s"
    endpoints:
      auth:
        capacity: 10
        refill-tokens: 5
        refill-duration: "60s"
      otp:
        capacity: 5
        refill-tokens: 3
        refill-duration: "60s"
      transfer:
        capacity: 20
        refill-tokens: 10
        refill-duration: "60s"

  # API Key Management
  api-keys:
    enabled: true
    rotation:
      enabled: true
      auto-rotate-days: 90
      warning-days: 7
      grace-period-days: 30
    header-name: "X-API-Key"
    bypass-paths:
      - "/health"
      - "/q/"
      - "/api/v1/auth/login"

  # Request Signing (HMAC-SHA256)
  request-signing:
    enabled: true
    algorithm: "HmacSHA256"
    header-name: "X-Signature"
    timestamp-header: "X-Timestamp"
    tolerance-seconds: 300  # 5 minutes
    required-paths:
      - "/v1/partner/*"
      - "/api/v1/partners/*"
    partner-keys:
      # Partner ID: Secret Key (base64 encoded)
      # In production, these should be stored securely (e.g., Vault)
      partner-1: "c2VjcmV0LWtleS0x"

  # IP Whitelisting
  ip-whitelist:
    enabled: true
    mode: "allow"  # allow or deny
    paths:
      - pattern: "/v1/partner/*"
        ips:
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"
      - pattern: "/api/v1/backoffice/*"
        ips:
          - "10.0.0.0/8"
          - "172.16.0.0/12"
    bypass-headers:
      - "X-Bypass-IP-Check"

  # Retry Policies
  retry:
    enabled: true
    default:
      max-retries: 3
      initial-interval: "1s"
      max-interval: "10s"
      multiplier: 2.0
      jitter: "0.2"
    per-service:
      account-service:
        max-retries: 3
        initial-interval: "500ms"
      transaction-service:
        max-retries: 5
        initial-interval: "1s"
      notification-service:
        max-retries: 2  # Fewer retries for notifications
        initial-interval: "2s"

  # Timeout Policies
  timeout:
    enabled: true
    default: "30s"
    per-service:
      account-service: "30s"
      auth-service: "10s"
      transaction-service: "30s"
      wallet-service: "15s"
      billing-service: "30s"
      notification-service: "10s"
      kyc-service: "60s"
      analytics-service: "30s"

  # Idempotency
  idempotency:
    enabled: true
    header-name: "X-Idempotency-Key"
    ttl: "24h"  # Keep idempotency records for 24 hours
    applicable-methods:
      - "POST"
      - "PUT"
      - "PATCH"
      - "DELETE"
